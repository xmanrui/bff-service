name: Build and Deploy to ACK

on:
  push:
    branches: [main]
  workflow_dispatch:

env:
  ACR_REGISTRY: ${{ secrets.ACR_REGISTRY }}
  ACR_NAMESPACE: ${{ secrets.ACR_NAMESPACE }}
  IMAGE_NAME: bff-service
  HELM_RELEASE: bff-service
  K8S_NAMESPACE: default

jobs:
  build:
    name: Build & Push Image
    runs-on: ubuntu-latest
    outputs:
      image_tag: ${{ steps.meta.outputs.image_tag }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set image tag
        id: meta
        run: echo "image_tag=${GITHUB_SHA::8}" >> "$GITHUB_OUTPUT"

      - name: Login to ACR
        run: docker login -u "${{ secrets.ACR_USERNAME }}" -p "${{ secrets.ACR_PASSWORD }}" "${{ env.ACR_REGISTRY }}"

      - name: Build and push image
        run: |
          IMAGE_URL="${ACR_REGISTRY}/${ACR_NAMESPACE}/${IMAGE_NAME}"
          docker build -t "${IMAGE_URL}:${{ steps.meta.outputs.image_tag }}" -t "${IMAGE_URL}:latest" .
          docker push "${IMAGE_URL}:${{ steps.meta.outputs.image_tag }}"
          docker push "${IMAGE_URL}:latest"

  deploy:
    name: Deploy to ACK
    runs-on: ubuntu-latest
    needs: build
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up kubeconfig
        run: |
          mkdir -p $HOME/.kube
          echo "${{ secrets.KUBE_CONFIG }}" | base64 -d > $HOME/.kube/config
          chmod 600 $HOME/.kube/config

      - name: Install Helm
        uses: azure/setup-helm@v4

      - name: Deploy with Helm
        run: |
          helm upgrade --install ${HELM_RELEASE} ./helm/bff-service \
            --namespace ${K8S_NAMESPACE} \
            --set image.repository="${ACR_REGISTRY}/${ACR_NAMESPACE}/${IMAGE_NAME}" \
            --set image.tag="${{ needs.build.outputs.image_tag }}" \
            --set database.host="${{ secrets.DB_HOST }}" \
            --set database.port="${{ secrets.DB_PORT }}" \
            --set database.name="${{ secrets.DB_NAME }}" \
            --set database.username="${{ secrets.DB_USERNAME }}" \
            --set database.password="${{ secrets.DB_PASSWORD }}" \
            --set app.secretKey="${{ secrets.APP_SECRET_KEY }}" \
            --wait \
            --timeout 300s

      - name: Verify deployment
        run: kubectl rollout status deployment/${HELM_RELEASE} -n ${K8S_NAMESPACE} --timeout=120s
